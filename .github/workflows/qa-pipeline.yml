name: QA Pipeline

on:
  pull_request:
    branches: [qa, staging, main]
  push:
    branches: [qa]

env:
  ENVIRONMENT: qa

jobs:

  # ------------------------------------------
  # Job 1: Lint y Build
  # ------------------------------------------
  build:
    name: Build & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Backend
        run: |
          cd fuc-sena
          docker build -t fuc-backend:qa .

      - name: Build Frontend
        run: |
          cd fuc-app-web
          docker build --target dev -t fuc-frontend:qa .

  # ------------------------------------------
  # Job 2: Backend Unit Tests
  # ------------------------------------------
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run Go Tests
        working-directory: fuc-sena
        run: go test ./... -v -race -coverprofile=coverage.out -covermode=atomic

      - name: Upload Backend Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: fuc-sena/coverage.out
          retention-days: 14

  # ------------------------------------------
  # Job 3: Frontend Unit Tests
  # ------------------------------------------
  frontend-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: fuc-app-web/pnpm-lock.yaml

      - name: Install Dependencies
        working-directory: fuc-app-web
        run: pnpm install --frozen-lockfile

      - name: Run Vitest
        working-directory: fuc-app-web
        run: pnpm test -- --coverage

      - name: Upload Frontend Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: fuc-app-web/coverage/
          retention-days: 14

  # ------------------------------------------
  # Job 4: QA Completo (depende de build + unit tests)
  # ------------------------------------------
  qa:
    name: QA Suite
    runs-on: ubuntu-latest
    needs: [build, backend-tests, frontend-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Create env file
        run: |
          cp .env.qa .env.qa.ci
          echo "SONAR_HOST_URL=${{ secrets.SONAR_HOST_URL }}" >> .env.qa.ci
          echo "SONAR_TOKEN=${{ secrets.SONAR_TOKEN }}" >> .env.qa.ci

      - name: Run Docker QA
        run: |
          docker compose \
            --env-file .env.qa.ci \
            -f docker-compose.qa.yml \
            up --build --abort-on-container-exit --exit-code-from qa-runner

      - name: Upload QA Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-reports
          path: qa/reports/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.qa.yml down -v --remove-orphans

  # ------------------------------------------
  # Job 5: Sonar (analisis separado)
  # ------------------------------------------
  sonar:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Backend Coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: fuc-sena/

      - name: Download Frontend Coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: fuc-app-web/coverage/

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
